---
layout: journal
title: Adding Custom Form API Elements to Drupal
categories: 
show_chat: true
show_contacts: false
---

In a previous post, we took a look at how to collect a customized date in Drupal. You may have noticed that there are warnings that the Day field are undefined, and that Drupal returns a form error saying the <a href="http://api.drupal.org/api/drupal/includes%21form.inc/function/date_validate/7" target="_blank">&#39;specified date is invalid&#39;</a>. This is because we are not passing a day part. In most cases, you would, but using the previous example again of submitting a credit card expiration date, you don&#39;t need it. So, how can we solve this problem? Drupal provides an easy way to define your own form elements through the use of <a href="http://api.drupal.org/api/drupal/modules!system!system.api.php/function/hook_element_info/7" target="_blank">hook_element_info</a>. With this function, we can quickly define new Form API elements to use- in this case, we want to create a custom date field, modeled after the core date field. While we&#39;re at it, lets also create two more fields that are related- credit card number, and credit card CVV code fields. The code to define your elements is simple: <pre>function creditfield_element_info() { $types[&#39;creditfield_cardnumber&#39;] = array( &#39;#input&#39; =&gt; TRUE, &#39;#element_validate&#39; =&gt; array(&#39;creditfield_cardnumber_validate&#39;), &#39;#autocomplete_path&#39; =&gt; FALSE, &#39;#process&#39; =&gt; array(&#39;form_process_creditfield&#39;), &#39;#theme&#39; =&gt; &#39;textfield&#39;, &#39;#theme_wrappers&#39; =&gt; array(&#39;form_element&#39;), &#39;#maxlength&#39; =&gt; 16, ); $types[&#39;creditfield_date&#39;] = array( &#39;#input&#39; =&gt; TRUE, &#39;#element_validate&#39; =&gt; array(&#39;creditfield_date_validate&#39;), &#39;#process&#39; =&gt; array(&#39;form_process_creditfield_date&#39;), &#39;#theme&#39; =&gt; &#39;date&#39;, &#39;#theme_wrappers&#39; =&gt; array(&#39;form_element&#39;), ); $types[&#39;creditfield_cvv&#39;] = array( &#39;#input&#39; =&gt; TRUE, &#39;#element_validate&#39; =&gt; array(&#39;creditfield_cvv_validate&#39;), &#39;#autocomplete_path&#39; =&gt; FALSE, &#39;#process&#39; =&gt; array(&#39;form_process_creditfield&#39;), &#39;#theme&#39; =&gt; &#39;textfield&#39;, &#39;#theme_wrappers&#39; =&gt; array(&#39;form_element&#39;), &#39;#maxlength&#39; =&gt; 4, ); return $types;}</pre>Breaking it down, we are simply defining 3 elements, validators, and processors. Since the date field is the complicated one, lets look at its #process callback, form_process_creditfield_date. This function determines how the field is constructed. <pre>function form_process_creditfield_date($element) { // Default to current date if (empty($element[&#39;#value&#39;])) { $element[&#39;#value&#39;] = array( &#39;month&#39; =&gt; format_date(REQUEST_TIME, &#39;custom&#39;, &#39;n&#39;), &#39;year&#39; =&gt; format_date(REQUEST_TIME, &#39;custom&#39;, &#39;Y&#39;), ); } $element[&#39;#tree&#39;] = TRUE; // Determine the order of month &amp; year in the site&#39;s chosen date format. $format = variable_get(&#39;date_format_short&#39;, &#39;m/Y&#39;); $sort = array(); $sort[&#39;month&#39;] = max(strpos($format, &#39;m&#39;), strpos($format, &#39;M&#39;)); $sort[&#39;year&#39;] = strpos($format, &#39;Y&#39;); asort($sort); $order = array_keys($sort); // Output multi-selector for date. foreach ($order as $type) { switch ($type) { case &#39;month&#39;: $options = drupal_map_assoc(range(1, 12), &#39;map_month&#39;); $title = t(&#39;Month&#39;); break; case &#39;year&#39;: $options = drupal_map_assoc(range(date(&#39;Y&#39;, time()), date(&#39;Y&#39;, time()) + 10)); $title = t(&#39;Year&#39;); break; } $element[$type] = array( &#39;#type&#39; =&gt; &#39;select&#39;, &#39;#title&#39; =&gt; $title, &#39;#title_display&#39; =&gt; &#39;invisible&#39;, &#39;#value&#39; =&gt; $element[&#39;#value&#39;][$type], &#39;#attributes&#39; =&gt; $element[&#39;#attributes&#39;], &#39;#options&#39; =&gt; $options, ); } return $element;}</pre>I modeled this after the Drupal core form_process_date function, except we have removed the &#39;day&#39; field logic, as well as changed the year options to be the current year plus 10 years, instead of the default of 1950-2050 range. When you call this field type in your form, you get a date field with just the month and year. Adding in the validation, there won&#39;t be too much more you have to do in your form: <pre>function creditfield_date_validate($element) { if ($element[&#39;#value&#39;][&#39;year&#39;] == date(&#39;Y&#39;, time()) &amp;&amp; $element[&#39;#value&#39;][&#39;month&#39;] &lt; date(&#39;m&#39;, time())) { form_error($element, t(&#39;Please enter a valid expiration date.&#39;)); }}</pre>When the form is submitted, this validate function is called because we defined that in #element_validate in our element definition. Its a rather simple check to see that the person has submitted a valid expiration date, which is nothing more than the date not being in the past if the year is the current year. So, a user should not be able to submit January 2012, for example.&nbsp; <h3>Now what?</h3>Great! Now you have some new field types for Drupal Form API to use. Let&#39;s use them! It is really easy to do: <pre>$form[&#39;credit_card_number&#39;] = array( &#39;#type&#39; =&gt; &#39;creditfield_cardnumber&#39;, &#39;#title&#39; =&gt; &#39;Credit Card Number&#39;, &#39;#maxlength&#39; =&gt; 16,); $form[&#39;expiration_date&#39;] = array( &#39;#type&#39; =&gt; &#39;creditfield_date&#39;, &#39;#title&#39; =&gt; &#39;Expiration Date&#39;,);$form[&#39;credit_card_cvv&#39;] = array( &#39;#type&#39; =&gt; &#39;creditfield_cvv&#39;, &#39;#title&#39; =&gt; &#39;CVV Code&#39;, &#39;#maxlength&#39; =&gt; 4, &#39;#description&#39; =&gt; &#39;Your 3 or 4 digit security code on the back of your card.&#39;,);</pre>Just your straightforward Form API code! That&#39;s it! You don&#39;t have to write any form validation callbacks, because the elements will fire them automatically, but you can still add more if you want. Now that there are new elements, you can create multiple forms without duplicating the validation code in each one. If you&#39;d like to see the rest of the code, including credit card number validation, check out the <a href="http://drupal.org/project/creditfield" target="_blank">Creditfield module</a>.